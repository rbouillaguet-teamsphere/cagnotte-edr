<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cagnotte ‚Äì √âcole de Rugby ROC Giffois</title>
  <meta name="description" content="Soutenez l'EDR du ROC Giffois : aidez-nous √† financer les d√©placements en bus et le voyage de fin d'ann√©e." />
  <meta property="og:title" content="Cagnotte ‚Äì √âcole de Rugby ROC Giffois" />
  <meta property="og:description" content="Soutenez l'EDR du ROC Giffois : aidez-nous √† financer les d√©placements en bus et le voyage de fin d'ann√©e." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/3/3a/Rugby_union_pictogram.svg" />
  <meta name="theme-color" content="#FFCC00" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --roc-yellow:#FFCC00; /* jaune ROC */
      --roc-black:#111111;  /* noir profond */
      --bg:#0b0b0b;         /* arri√®re-plan */
      --card:#191919;       /* carte */
      --muted:#9b9b9b;      /* texte secondaire */
      --success:#2ecc71;    /* vert succ√®s */
      --danger:#ff5252;     /* alerte */
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:linear-gradient(180deg,#0b0b0b, #121212 35%, #0b0b0b);color:#fff;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    a{color:var(--roc-yellow);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrapper{max-width:1050px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;gap:18px;padding:16px 0}
    header img.logo{width:64px;height:64px;object-fit:contain;filter:drop-shadow(0 0 12px rgba(255,204,0,.25))}
    header .club{display:flex;flex-direction:column}
    header .club h1{font-size:1.6rem;margin:0;font-weight:800;letter-spacing:.2px}
    header .club span{font-size:.95rem;color:var(--muted)}

    .hero{display:grid;grid-template-columns:1.2fr .8fr;gap:20px;margin:10px 0 22px}
    @media (max-width:880px){.hero{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid #2a2a2a;border-radius:18px;padding:18px;box-shadow:0 10px 24px rgba(0,0,0,.25)}
    .card h2{margin:0 0 10px;font-size:1.25rem}

    /* Progress */
    .progress{background:#0e0e0e;border:1px solid #2a2a2a;border-radius:12px;overflow:hidden;height:18px;position:relative}
    .progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--roc-yellow),#ffd84d);width:0%;transition:width .8s ease}
    .progress-labels{display:flex;justify-content:space-between;align-items:center;margin-top:10px;color:#ddd;font-weight:600}
    .progress-labels small{color:var(--muted);font-weight:500}

    .cta{display:flex;gap:12px;margin-top:16px;flex-wrap:wrap}
    .btn{appearance:none;cursor:pointer;border:none;border-radius:12px;padding:12px 16px;font-weight:700}
    .btn-primary{background:var(--roc-yellow);color:#111}
    .btn-primary:hover{filter:brightness(1.05)}
    .btn-primary:disabled{opacity:0.6;cursor:not-allowed}
    .btn-outline{background:transparent;color:#fff;border:1px solid #3a3a3a}
    .btn-outline:hover{border-color:#595959}

    .badges{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .badge{border:1px solid #2e2e2e;border-radius:999px;padding:6px 10px;font-size:.85rem;color:#ddd}

    .cols{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px}
    @media (max-width:880px){.cols{grid-template-columns:1fr}}

    .donors{display:grid;gap:10px;max-height:420px;overflow:auto;padding-right:4px}
    .donor{display:flex;gap:10px;align-items:flex-start;background:#121212;border:1px solid #262626;border-radius:12px;padding:10px}
    .donor .avatar{width:36px;height:36px;border-radius:50%;background:#222;border:1px solid #333;display:grid;place-items:center;font-weight:800;color:#111;background:var(--roc-yellow)}
    .donor .meta{display:flex;flex-direction:column}
    .donor .meta .top{display:flex;gap:8px;align-items:center}
    .donor .name{font-weight:700}
    .donor .amount{font-weight:800;color:#fff;background:#1f1f1f;border:1px solid #333;border-radius:8px;padding:2px 8px}
    .donor .msg{color:#cfcfcf;margin-top:2px}

    .gallery{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:680px){.gallery{grid-template-columns:1fr 1fr}}
    .gallery img{width:100%;height:140px;object-fit:cover;border-radius:12px;border:1px solid #2a2a2a}

    .faq details{background:#121212;border:1px solid #262626;border-radius:12px;padding:12px}
    .faq details+details{margin-top:10px}
    .faq summary{cursor:pointer;font-weight:700}

    footer{margin:32px 0 8px;color:#a5a5a5;font-size:.9rem}
    .legal{font-size:.85rem;color:#9a9a9a;margin-top:8px}
    .stripe-logos{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
    .chip{border:1px solid #2a2a2a;border-radius:10px;padding:6px 8px;color:#ddd;font-size:.85rem}
    .qr{background:#0f0f0f;border:1px dashed #2a2a2a;border-radius:12px;padding:10px;display:grid;place-items:center}
    .notice{background:#141414;border:1px solid #333;border-left:6px solid var(--roc-yellow);border-radius:12px;padding:12px;color:#eaeaea}
  </style>
</head>
<body>
  <div class="wrapper">
    <header>
      <!-- Remplace l'URL du logo par celui du club -->
      <img class="logo" src="/public/images/LogoEDR.png" alt="Logo ROC Giffois"/>
      <div class="club">
        <h1>üñ§üíõ Cagnotte ‚Äì √âcole de Rugby Giffoise</h1>
        <span>Objectif : financer <strong>les d√©placements en bus</strong> et le <strong>voyage de fin d'ann√©e</strong>.</span>
      </div>
    </header>

    <section class="hero">
      <article class="card">
        <h2>Votre soutien fait rouler nos joueurs üêù</h2>
        <p style="color:#eaeaea;line-height:1.6">
          Chaque week-end, nos jeunes jouent partout en Essonne (et au‚Äëdel√† !). Vos dons financent directement les <strong>bus pour les plateaux</strong> et le <strong>voyage de fin d'ann√©e</strong> qui r√©compense leur engagement toute la saison. Merci pour votre aide üôè
        </p>

        <div class="progress" aria-label="Progression de la cagnotte">
          <span id="progressBar"></span>
        </div>
        <div class="progress-labels">
          <div>
            <span id="raisedLabel">0 ‚Ç¨</span> collect√©s <small>(<span id="donationsCount">0</span> dons)</small>
          </div>
          <div>
            Objectif : <strong id="goalLabel">‚Äî</strong>
          </div>
        </div>
        
        <div id="donationForm" style="margin-top:12px;display:flex;flex-direction:column;gap:8px;">
          <input id="donorName" type="text" placeholder="Votre pr√©nom (facultatif)" 
           style="padding:10px;border-radius:8px;border:1px solid #333;background:#121212;color:#eee;">
          <input id="donorMsg" type="text" placeholder="Un mot d'encouragement üíõ (facultatif)" 
           style="padding:10px;border-radius:8px;border:1px solid #333;background:#121212;color:#eee;">
        </div>

        <div class="cta">
          <button id="donateBtn" class="btn btn-primary">üéÅ Je participe</button>
          <button id="shareBtn" class="btn btn-outline">üîó Partager</button>
          <a id="qrToggle" class="btn btn-outline" href="#qr" onclick="toggleQR(event)">üì± Afficher le QR Code</a>
        </div>
        
        <div id="qr" class="qr" style="display:none; margin-top:14px">
          <img id="qrImg" alt="QR vers la page de paiement" />
          <div class="legal" style="text-align:center">Scannez pour ouvrir la page de paiement</div>
        </div>
      </article>

      <aside class="card">
        <h2>Derniers donateurs üíõ</h2>
        <div id="donorsList" class="donors" aria-live="polite"></div>
        <div class="legal">Envie d'appara√Ætre ici ? Laissez votre pr√©nom lors du paiement.</div>
      </aside>
    </section>

    <section class="cols">
      <article class="card">
        <h2>√Ä quoi servira votre don ?</h2>
        <ul style="line-height:1.8;color:#eaeaea">
          <li>üöå <strong>D√©placements en bus</strong> pour les plateaux et tournois</li>
          <li>üèïÔ∏è <strong>Voyage de fin d'ann√©e</strong> (h√©bergement, repas, activit√©s)</li>
          <li>üõ°Ô∏è <strong>S√©curit√© & confort</strong> (eau, collations, petits mat√©riels)</li>
        </ul>
        <div class="notice" style="margin-top:10px">
          <strong>Transparence :</strong> le total et l'usage des fonds seront pr√©sent√©s au comit√© directeur et partag√©s aux parents en fin de saison.
        </div>  
      </article>

      <article class="card">
        <h2>En images üì∏</h2>
        <div class="gallery">
          <!-- Remplacez par vos photos club -->
          <img src="/public/images/image3.jpg?q=80&w=800&auto=format&fit=crop" alt="Match jeunes"/>
          <img src="/public/images/image2.jpg?q=80&w=800&auto=format&fit=crop" alt="Entrainement"/>
          <img src="/public/images/image4.jpg?q=80&w=800&auto=format&fit=crop" alt="Coh√©sion"/>
          <img src="/public/images/image1.jpg?q=80&w=800&auto=format&fit=crop" alt="Coh√©sion"/>
        </div>
      </article>
    </section>

    <section class="card" style="margin-top:20px">
      <h2>Questions fr√©quentes</h2>
      <div class="faq">
        <details>
          <summary>Comment payer en ligne ?</summary>
          <p>Cliquer sur <strong>"Je participe"</strong> ouvre une page de paiement s√©curis√©e. Carte bancaire, PayPal accept√©s. Aucun compte n√©cessaire.</p>
        </details>
        <details>
          <summary>C'est s√©curis√© ?</summary>
          <p>Oui ! Le paiement est g√©r√© par <strong>Stripe</strong> (ou HelloAsso), une solution de paiement certifi√©e et utilis√©e par des millions d'associations.</p>
        </details>
        <details>
          <summary>Est-ce d√©ductible fiscalement ?</summary>
          <p>Si votre club est reconnu d'int√©r√™t g√©n√©ral, oui. Renseignez‚Äëvous aupr√®s du tr√©sorier pour obtenir un re√ßu fiscal.</p>
        </details>
        <details>
          <summary>Je ne peux pas donner en ligne. Comment faire ?</summary>
          <p>Pas de souci ! Contactez le tr√©sorier via <a href="mailto:tresorier@rocgiffois.fr">tresorier@rocgiffois.fr</a> pour organiser un don en esp√®ces ou par ch√®que.</p>
        </details>
      </div>
    </section>

    <footer>
      <strong>ROC Giffois ‚Äì √âcole de Rugby</strong><br>
      Stade de Moulon, Gif‚Äësur‚ÄëYvette
      <div class="legal">
        Contact : <a href="mailto:contact@rocgiffois.fr">contact@rocgiffois.fr</a> | ¬© <span id="year">2025</span> ROC Giffois
      </div>
      <div class="stripe-logos">
        <span class="chip">Paiements s√©curis√©s par Stripe</span>
        <span class="chip">Visa, Mastercard, PayPal</span>
      </div>
    </footer>
  </div>

  <!-- ==============================
       Configuration dynamique
       ============================== -->
  <script>
    const DONATION_CONFIG = {
      goal: 8000,
      initialRaised: 0,
      donationsCount: 0,
      paymentUrl: window.location.origin  // Pour le QR code
    };

    const fmt = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' });

    function renderProgress() {
      const pct = Math.min(100, (DONATION_CONFIG.initialRaised / DONATION_CONFIG.goal) * 100);
      document.getElementById('progressBar').style.width = pct + '%';
      document.getElementById('raisedLabel').textContent = fmt.format(DONATION_CONFIG.initialRaised);
      document.getElementById('goalLabel').textContent = fmt.format(DONATION_CONFIG.goal);
      document.getElementById('donationsCount').textContent = DONATION_CONFIG.donationsCount;
    }

    async function openPayment() {
      const name = document.getElementById('donorName').value.trim();
      const msg = document.getElementById('donorMsg').value.trim();
      const amount = prompt("Montant du don (‚Ç¨)", "20");

      if (!amount || isNaN(amount) || parseFloat(amount) <= 0) {
        alert("Veuillez entrer un montant valide");
        return;
      }

      // D√©sactiver le bouton pendant le traitement
      const btn = document.getElementById('donateBtn');
      btn.disabled = true;
      btn.textContent = "‚è≥ Chargement...";

      try {
        const res = await fetch("/api/createCheckoutSession", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            name: name || "Anonyme", 
            msg: msg || "", 
            amount: parseFloat(amount) 
          }),
        });

        if (!res.ok) {
          throw new Error(`Erreur HTTP: ${res.status}`);
        }

        const data = await res.json();
        
        if (data.url) {
          window.location.href = data.url;
        } else {
          throw new Error("URL de paiement non re√ßue");
        }
      } catch (error) {
        console.error("Erreur lors de la cr√©ation de la session:", error);
        alert("Une erreur est survenue. Veuillez r√©essayer.");
        btn.disabled = false;
        btn.textContent = "üéÅ Je participe";
      }
    }

    function share(){
      const shareData = {
        title: 'Cagnotte EDR ‚Äì ROC Giffois',
        text: 'J'aide l'EDR du ROC Giffois √† financer les bus et le voyage de fin d'ann√©e !',
        url: window.location.href
      };
      if(navigator.share){
        navigator.share(shareData).catch(()=>{});
      } else {
        navigator.clipboard.writeText(shareData.url).then(()=>{
          alert('Lien copi√© ! Merci pour le partage üíõ');
        });
      }
    }

    function updateQR(){
      const url = DONATION_CONFIG.paymentUrl || window.location.href;
      const encoded = encodeURIComponent(url);
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=320x320&data=${encoded}`;
      document.getElementById('qrImg').src = qrUrl;
    }

    function toggleQR(ev){
      if(ev) ev.preventDefault();
      const box = document.getElementById('qr');
      box.style.display = box.style.display === 'none' ? 'grid' : 'none';
    }

    document.getElementById('donateBtn').addEventListener('click', openPayment);
    document.getElementById('shareBtn').addEventListener('click', share);
    document.getElementById('year').textContent = new Date().getFullYear();

    renderProgress();
    updateQR();

    // ==============================
    //  Chargement du total dynamique
    // ==============================
    async function updateTotalFromServer() {
      try {
        const res = await fetch('/api/getTotal');
        if (!res.ok) throw new Error('Erreur r√©seau');
        
        const data = await res.json();

        if (data.total !== undefined) {
          DONATION_CONFIG.initialRaised = data.total;
          DONATION_CONFIG.donationsCount = data.count || 0;
          renderProgress();
        }
      } catch (err) {
        console.error('Erreur lors de la r√©cup√©ration du total:', err);
      }
    }

    updateTotalFromServer();
    setInterval(updateTotalFromServer, 15000);
  </script>

  <!-- ==============================
       Module s√©par√© : lecture Firestore
       ============================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBQimcuRGYNeZhAqKb-pH8pkU5CDEx7UDw",
      authDomain: "cagnotte-edr.firebaseapp.com",
      projectId: "cagnotte-edr",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const fmt = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' });

    function initials(name) {
      return (name || 'A').trim().split(/\s+/).slice(0, 2).map(n => n[0]).join('').toUpperCase();
    }

    async function renderDonors() {
      const list = document.getElementById("donorsList");
      list.innerHTML = "";

      try {
        const q = query(collection(db, "donations"), orderBy("date", "desc"), limit(20));
        const snapshot = await getDocs(q);
        const donors = snapshot.docs.map((doc) => doc.data());

        donors.forEach((d) => {
          const el = document.createElement("div");
          el.className = "donor";
          el.innerHTML = `
            <div class="avatar" aria-hidden="true">${initials(d.name)}</div>
            <div class="meta">
              <div class="top">
                <span class="name">${d.name || "Anonyme"}</span>
                <span class="amount">${fmt.format(d.amount || 0)}</span>
                <small style="color:var(--muted)">${new Date(d.date).toLocaleDateString("fr-FR")}</small>
              </div>
              ${d.msg ? `<div class="msg">"${d.msg}"</div>` : ""}
            </div>
          `;
          list.appendChild(el);
        });

        if (donors.length === 0) {
          const empty = document.createElement("div");
          empty.className = "legal";
          empty.textContent = "Les premiers donateurs appara√Ætront ici ‚ú®";
          list.appendChild(empty);
        }
      } catch (err) {
        console.error("Erreur Firestore:", err);
        const errMsg = document.createElement("div");
        errMsg.className = "legal";
        errMsg.textContent = "Impossible de charger les donateurs.";
        list.appendChild(errMsg);
      }
    }

    renderDonors();
    setInterval(renderDonors, 30000);
  </script>
</body>
</html>